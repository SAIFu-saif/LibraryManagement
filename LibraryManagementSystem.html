<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Library Management System</title>
<style>
  :root {
    --accent: #4f46e5; --muted: #6b7280; --card: #ffffff; --page: #f4f6f8;
    --green-lcd: #133c22; --btn: #4f46e5; --success: #16a34a; --danger: #ef4444;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--page); margin: 0; color: #1f2937; -webkit-font-smoothing: antialiased;
  }
  .container { max-width: 1200px; margin: 28px auto; padding: 0 20px; }
  .header {
    background: var(--card); padding: 20px; border-radius: 12px; display: flex; gap: 16px;
    align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); flex-wrap: wrap;
  }
  .brand { display: flex; gap: 14px; align-items: center; }
  .logo {
    width: 44px; height: 44px; border-radius: 8px; background: linear-gradient(135deg, #60a5fa, #a78bfa);
    display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700;
  }
  .brand h1 { margin: 0; font-size: 1.4rem; }
  .right-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .status-indicator {
    background: var(--green-lcd); color: #7ef08a; padding: 12px 18px; border-radius: 8px;
    font-family: "SF Mono", "Courier New", monospace; font-weight: 600; min-width: 200px; text-align: center;
  }
  .status-indicator.offline { background: #4B0000; color: #ff8a8a; }
  .form-inline { display: flex; gap: 8px; align-items: center; }
  input[type="text"], input[type="date"], input[type="number"] {
     padding: 10px 12px; border-radius: 8px; border: 1px solid #e0e0e0; box-sizing: border-box; width: 100%;
  }
  input[type="text"] {min-width: 200px;}
  .btn {
    background: var(--btn); color: #fff; border: none; padding: 10px 14px;
    border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s;
  }
  .btn:hover { background: #4338ca; }
  .btn.secondary { background: #10b981; }
  .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-top: 24px; }
  .stat-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04); text-align: center; }
  .stat-card h2 { margin: 0; color: var(--accent); font-size: 2rem; }
  .stat-card p { margin: 8px 0 0; color: var(--muted); font-weight: 600; }
  .section { margin-top: 24px; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04); }
  .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; text-align: left; vertical-align: middle; }
  thead th { color: var(--muted); font-weight: 700; font-size: 0.85rem; text-transform: uppercase; }
  .action-btn { background: var(--accent); color: white; padding: 6px 12px; border: 0; border-radius: 6px; cursor: pointer; margin-right: 6px; font-size: 0.8rem; font-weight: bold; }
  .delete-btn { background: var(--danger); }
  .features-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
  .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .collapsed .collapsible-content { display: none; }
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 3000; }
  .modal-content { background: #fff; padding: 30px; border-radius: 16px; text-align: center; width: 350px; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">L</div>
      <div><h1>Library Management System</h1><div style="font-size: 12px; color: var(--muted)">Saifoddin Shaikh | Sant Gadge Baba University</div></div>
    </div>
    <div class="right-controls">
      <div id="esp32Status" class="status-indicator offline">ESP32 OFFLINE</div>
      <div class="form-inline">
        <input id="bookToIssueInput" type="text" placeholder="Enter Book ID">
        <input id="dueDateInput" type="date">
        <button id="prepareBtn" class="btn">Prepare Issue</button>
        <button id="manageRecordsBtn" class="btn secondary">Manage Records</button>
      </div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-card"><h2 id="totalStudents">0</h2><p>Total Students</p></div>
    <div class="stat-card"><h2 id="totalBooks">0</h2><p>Distinct Titles</p></div>
    <div class="stat-card"><h2 id="issuedBooks">0</h2><p>Total Books Out</p></div>
  </div>

  <section id="managementSection" class="section" style="display:none;">
    <div class="section-header"><h3>Inventory Management</h3><button id="addBookBtn" class="btn">+ Add Book</button></div>
    <table><thead><tr><th>BOOK ID</th><th>AUTHOR</th><th>STOCK</th><th>MANAGE</th></tr></thead><tbody id="booksTableBody"></tbody></table>
    <hr style="margin: 40px 0; border: 1px solid #f1f5f9; border-top: 0;">
    <div class="section-header"><h3>Student Registry</h3><button id="addStudentBtn" class="btn">+ Add Student</button></div>
    <table><thead><tr><th>UID (RFID)</th><th>NAME</th><th>ROLL #</th><th>MANAGE</th></tr></thead><tbody id="studentsTableBody"></tbody></table>
  </section>

  <div class="features-grid">
      <section class="section">
        <div class="section-header"><h3>Transaction History</h3><input id="historySearch" type="text" placeholder="Search..." style="max-width:300px"></div>
        <table><thead><tr><th>Time</th><th>Student</th><th>Book</th><th>Action</th><th>Manage</th></tr></thead><tbody id="transactionsTableBody"></tbody></table>
      </section>

      <section id="activeBorrowsSection" class="section">
        <div class="collapsible-header" id="toggleActiveBtn"><h3>Live: Active Borrows</h3><span>â–¼</span></div>
        <div class="collapsible-content"><table><thead><tr><th>Student</th><th>Book</th><th>Due Date</th></tr></thead><tbody id="activeBorrowsTableBody"></tbody></table></div>
      </section>
  </div>
</div>

<div id="modal-container"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, serverTimestamp, query, orderBy, deleteDoc, Timestamp, setDoc, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6sQDenmp94ENUX5VqkxtlDEWOFbYVj1M", 
    authDomain: "library-management-8c233.firebaseapp.com", 
    projectId: "library-management-8c233",
    storageBucket: "library-management-8c233.appspot.com", 
    messagingSenderId: "841300454271", 
    appId: "1:841300454271:web:79c5bc37f99f55c5d9c84a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let studentsMap = new Map();
  let booksMap = new Map();
  let transactions = [];
  let preparedIssue = null;
  let returnAuthPromise = null;
  let searchQuery = "";

  function init() {
    setupRealtimeListeners();
    bindUIEvents();
    document.getElementById('dueDateInput').value = new Date(Date.now() + 12096e5).toISOString().split('T')[0];
  }

  function setupRealtimeListeners() {
    onSnapshot(collection(db, "Students"), (s) => { s.docs.forEach(d => studentsMap.set(d.id, { ...d.data(), id: d.id })); renderStudents(); });
    onSnapshot(collection(db, "Books"), (s) => { s.docs.forEach(d => booksMap.set(d.id, { ...d.data(), id: d.id })); renderBooks(); renderDashboard(); });
    onSnapshot(query(collection(db, "Transactions"), orderBy("timestamp", "desc")), (s) => { transactions = s.docs.map(d => ({ id: d.id, ...d.data() })); renderTransactionsAndActive(); });
    
    onSnapshot(collection(db, "Scans"), async (s) => {
      for (const change of s.docChanges()) {
        if (change.type === "added") {
          const { uid } = change.doc.data();
          document.getElementById('esp32Status').textContent = `SCANNED: ${uid}`;
          document.getElementById('esp32Status').classList.remove("offline");

          if (returnAuthPromise && returnAuthPromise.expectedUid === uid) {
             returnAuthPromise.resolve(); returnAuthPromise = null;
          } else if (preparedIssue) {
            const { bookId, dueDate } = preparedIssue;
            preparedIssue = null;
            // FIX: Every scan creates a separate document, allowing multiple books
            await addDoc(collection(db, "Transactions"), { 
                uid, 
                book: bookId, 
                action: "Issued", 
                timestamp: serverTimestamp(), 
                dueDate: Timestamp.fromDate(new Date(dueDate)) 
            });
            await updateDoc(doc(db, "Books", bookId), { availableQuantity: increment(-1) });
            document.getElementById('bookToIssueInput').value = "";
          }
          await deleteDoc(doc(db, "Scans", change.doc.id));
        }
      }
    });
  }

  function renderTransactionsAndActive() {
    const hBody = document.getElementById('transactionsTableBody');
    const aBody = document.getElementById('activeBorrowsTableBody');
    hBody.innerHTML = ""; aBody.innerHTML = "";
    
    transactions.forEach(tx => {
      const student = studentsMap.get(tx.uid)?.name || tx.uid;
      const isMatch = student.toLowerCase().includes(searchQuery) || tx.uid.toLowerCase().includes(searchQuery);
      
      // FIX: Transaction History shows all unique issue entries
      if (isMatch) {
        const row = hBody.insertRow();
        row.innerHTML = `<td>${tx.timestamp?.toDate().toLocaleTimeString() || "..."}</td><td>${student}</td><td>${tx.book}</td><td>${tx.action}</td>
        <td>${tx.action === 'Issued' ? `<button class="action-btn return-btn" data-tx-id="${tx.id}" data-book-id="${tx.book}" data-uid="${tx.uid}">Return</button>` : '-'}</td>`;
      }
      
      // FIX: Active Borrows list shows every individual book out, even if same student
      if (tx.action === 'Issued') {
        const aRow = aBody.insertRow();
        aRow.innerHTML = `<td><b>${student}</b></td><td>${tx.book}</td><td>${tx.dueDate ? tx.dueDate.toDate().toLocaleDateString() : "-"}</td>`;
      }
    });
  }

  function bindUIEvents() {
    document.getElementById('prepareBtn').onclick = () => {
        const bId = document.getElementById('bookToIssueInput').value.trim();
        if (!booksMap.has(bId)) return alert("Invalid Book ID.");
        preparedIssue = { bookId: bId, dueDate: document.getElementById('dueDateInput').value };
        document.getElementById('esp32Status').textContent = `READY: ${bId}. Scan Card.`;
    };
    document.getElementById('manageRecordsBtn').onclick = () => {
        const sec = document.getElementById('managementSection');
        sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
    };
    document.body.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if (e.target.classList.contains('edit-book-btn')) showModal('book', booksMap.get(id));
        if (e.target.classList.contains('edit-student-btn')) showModal('student', studentsMap.get(id));
        if (e.target.classList.contains('return-btn')) {
            const { txId, bookId, uid } = e.target.dataset;
            // FIX: Handshake verifies the student is present before specific transaction is closed
            if (await waitForScan(uid)) {
                await updateDoc(doc(db, "Books", bookId), { availableQuantity: increment(1) });
                await updateDoc(doc(db, "Transactions", txId), { action: 'Returned' });
                alert(`${bookId} successfully returned.`);
            }
        }
    });
    document.getElementById('toggleActiveBtn').onclick = () => document.getElementById('activeBorrowsSection').classList.toggle('collapsed');
    document.getElementById('addStudentBtn').onclick = () => showModal('student');
    document.getElementById('addBookBtn').onclick = () => showModal('book');
    document.getElementById('historySearch').oninput = (e) => { searchQuery = e.target.value.toLowerCase(); renderTransactionsAndActive(); };
  }

  function renderBooks() {
    const tb = document.getElementById('booksTableBody'); tb.innerHTML = "";
    booksMap.forEach((v, k) => {
        const r = tb.insertRow();
        r.innerHTML = `<td><b>${k}</b></td><td>${v.author || 'N/A'}</td><td>${v.availableQuantity}/${v.totalQuantity}</td><td><button class="action-btn edit-book-btn" data-id="${k}">Edit</button></td>`;
    });
  }

  function renderStudents() {
    const tb = document.getElementById('studentsTableBody'); tb.innerHTML = "";
    studentsMap.forEach((v, k) => { tb.insertRow().innerHTML = `<td>${k}</td><td>${v.name}</td><td>${v.roll || 'N/A'}</td><td><button class="action-btn edit-student-btn" data-id="${k}">Edit</button></td>`; });
  }

  function showModal(type, data = null) {
    const isEdit = data !== null;
    const container = document.getElementById('modal-container');
    container.innerHTML = `<div class="modal-backdrop"><div class="modal-content">
        <h3>${isEdit ? 'Edit' : 'Add'} ${type}</h3>
        <input id="m1" type="text" placeholder="ID" value="${isEdit ? data.id : ''}" ${isEdit ? 'disabled' : ''} style="margin-bottom:10px">
        <input id="m2" type="text" placeholder="Name/Author" value="${isEdit ? (type === 'student' ? data.name : data.author) : ''}" style="margin-bottom:10px">
        ${type === 'book' ? `<input id="m3" type="number" placeholder="Total Stock" value="${isEdit ? data.totalQuantity : '5'}" style="margin-bottom:10px">` : ''}
        <button id="msave" class="btn">Save</button>
        <button class="btn secondary" onclick="document.getElementById('modal-container').innerHTML=''">Cancel</button>
    </div></div>`;
    document.getElementById('msave').onclick = async () => {
        const id = document.getElementById('m1').value;
        const sub = document.getElementById('m2').value;
        if (type === 'student') await setDoc(doc(db, "Students", id), { name: sub });
        else {
            const q = parseInt(document.getElementById('m3').value);
            const docData = { author: sub, totalQuantity: q };
            if (!isEdit) docData.availableQuantity = q;
            else docData.availableQuantity = increment(q - data.totalQuantity);
            await setDoc(doc(db, "Books", id), docData, { merge: true });
        }
        container.innerHTML = "";
    };
  }

  function waitForScan(uid) {
    return new Promise((resolve) => {
      const container = document.getElementById('modal-container');
      container.innerHTML = `<div class="modal-backdrop"><div class="modal-content"><h2>Verification Required</h2><p>Please scan card for student: <b>${uid}</b></p></div></div>`;
      returnAuthPromise = { expectedUid: uid, resolve: () => { container.innerHTML = ''; resolve(true); } };
      setTimeout(() => { if (returnAuthPromise) { returnAuthPromise = null; container.innerHTML = ""; resolve(false); } }, 20000);
    });
  }

  function renderDashboard() {
    document.getElementById('totalStudents').textContent = studentsMap.size;
    document.getElementById('totalBooks').textContent = booksMap.size;
    let out = 0; booksMap.forEach(b => out += (b.totalQuantity - b.availableQuantity));
    document.getElementById('issuedBooks').textContent = out;
  }
  
  init();
</script>
</body>
</html>